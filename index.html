<!doctype html>

<html lang="en">

<head>
  <meta charset="utf-8">

  <title>City of Surrey - Water Meter Locator</title>
  <meta name="description" content="Find City of Surrey Water Meter">
  <meta name="author" content="Ryan Scovill">
  <meta name="viewport" content="width=device-width, initial-scale=1">

  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.7.0/css/font-awesome.min.css">
  <link rel="stylesheet"
    href="https://cdn.jsdelivr.net/npm/@tarekraafat/autocomplete.js@7.2.0/dist/css/autoComplete.min.css">
  <link rel="stylesheet" href="css/styles.css">

</head>

<body>
  <div class="container">
    <div class="form">
      <h1>City of Surrey Water Meter Locator</h1>
      <form id="form">
        <div class="form-group">
          <label for="accoutnum">Account #: </label>
          <input type="text" id="accountnum" class="input input-md">
        </div>
        <label> <strong>
            <h3> OR </h3>
          </strong></label>
        <div class="form-group">
          <label for="addressInput">Address: </label>
          <input type="text" id="addressInput" class="input input-md" autocomplete="off">
        </div>
        <div class="form-group form-submit">
          <button type="submit" id="submit" value="Get Image" class="button">Get image</button>
          <i id="loading-spinner" class="fa fa-spinner fa-spin" style="display: none;"></i>
        </div>
        <div id="error" style="display: none">
          <p></p>
        </div>
      </form>
    </div>
    <div style="padding-top: 1em;">
      <div id="image-placeholder"></div>

    </div>
  </div>

  <footer>
    <p><a href="https://github.com/ryanscovill/surrey-water-meter-finder"><i class="fa fa-github"></i></a> | Note: This tool is not endorsed by the City of Surrey and is for educational purposes only.</p>
  </footer>

  <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.5.1/jquery.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/@tarekraafat/autocomplete.js@7.2.0/dist/js/autoComplete.min.js"></script>
  <script>
    $(document).ready(function () {

      document.getElementById('form').onsubmit = function (e) {
        e.preventDefault();
        accountNum = document.getElementById('accountnum').value;
        address = $('#addressInput').val();

        if (!$('#submit').hasClass("disabled")) {
          if (accountNum || address) {
            $('#image-placeholder').html('')
            $("#submit").addClass("disabled")
          }
          $('#loading-spinner').show();
          if (accountNum) {
            showImageAccountNum(accountNum);
          } else if (address) {
            showImage(address)
          } else {
            $('#loading-spinner').hide();
          }
        }
      }
      function showImageAccountNum(accountNum) {
        imgHtml = '<img class="meter-image" src="https://cosmos.surrey.ca/geo_ref/Images/Water/WaterMeterPhotos/' + accountNum + '.jpg" >';
        html = "<div>" + imgHtml + "</div>"
        $('#image-placeholder').append(html);
        disableSpinner();

      }
      function showImage(queryAddress) {
        // query for address
        url = "https://cosmos.surrey.ca/external/COSMOSWebServices/cosmos.svc/GetSearchData/" + encodeURIComponent(queryAddress) + "?page=1&start=0&limit=25"
        $.get(url, function (result) {
          if (result.length == 0) {
            showError("Could not find property.")
            return
          }
          // todo show address results and user chooses
          addressId = result[0]["FieldValue"];
          // get Address info
          url = "https://gisservices.surrey.ca/arcgis/rest/services/Public/Legal/MapServer/find?f=json&searchText=" + encodeURIComponent(addressId) + "&contains=false&returnGeometry=true&layers=0&searchFields=ADDRESSID"
          $.get(url, function (result) {
            if (!result.hasOwnProperty('results') || result.results.length == 0) {
              showError("Could not find property details.")
              return
            }
            houseNum = result.results[0].attributes["HOUSE NUMBER"]
            x = result.results[0].geometry.x;
            y = result.results[0].geometry.y;
            padding = 50
            boundingBox = { "xmin": x - 50, "ymin": y - 50, "xmax": x + 50, "ymax": y + 50 }
            boundingBoxParam = encodeURIComponent(JSON.stringify(boundingBox))
            mapExtentParam = encodeURIComponent([boundingBox["xmin"], boundingBox["ymin"], boundingBox["xmax"], boundingBox["ymax"]].join(","))
            url = "https://gisservices.surrey.ca/arcgis/rest/services/Public/Water/MapServer/identify?f=json&tolerance=5&returnGeometry=true&returnFieldName=false&returnUnformattedValues=false&imageDisplay=1011%2C888%2C96&geometry=" + boundingBoxParam + "&geometryType=esriGeometryEnvelope&mapExtent=" + mapExtentParam + "&layers=visible%3A1%2C2"
            // get water services
            $.get(url, function (result) {
              $('#image-placeholder').html('')
              disableSpinner()
              foundMeter = false;
              for (idx in result.results) {
                meter = result.results[idx]
                if (meter.hasOwnProperty('attributes') && meter.attributes.HOUSE == houseNum) {
                  foundMeter = true;
                  if (meter.attributes.hasOwnProperty('IMAGE') && meter.attributes.IMAGE.length > 1) {
                    imgHtml = `<img class="meter-image" src="${meter.attributes.IMAGE}">`;
                  } else {
                    imgHtml = "<p> No image found </p>"
                  }
                  html = `
                    <div class="card">
                      ${imgHtml}
                      <p>Meter Account: ${meter.attributes["ACCOUNT NUMBER"]}</p>
                      <p>Installed Date: ${meter.attributes["INSTALLED DATE"]}</p>
                      <p>Last Read: ${meter.attributes["LAST READ"]}</p>
                      <p>Last Read Date: ${meter.attributes["LAST READ DATE"]}</p>
                      <p>Location Description: ${meter.attributes["LOCATION DESCRIPTION"]}</p>
                    </div>
                      `
                  $('#image-placeholder').append(html)
                }
              }
              if (!foundMeter) {
                showError("Could not find a meter at this property.");
              } else {
                $('#error').hide()
              }
            }).fail(function () {
              showError();
            })
          }).fail(function () {
            showError();
          })
        }).fail(function () {
          showError();
        })
      }

      function showError(message) {
        defaultMessage = "An error occurred.  Please try using an account #."
        if (!message) {
          message = defaultMessage;
        }
        $('#error').show();
        $('#error p').text(message);
        disableSpinner();
      }

      function disableSpinner() {
        $("#submit").removeClass("disabled")
        $('#loading-spinner').hide()
      }
    })

    new autoComplete({
      data: {
        src: async () => {
          const query = document.querySelector("#addressInput").value;
          const url = "https://cosmos.surrey.ca/external/COSMOSWebServices/cosmos.svc/GetSearchData/" + encodeURIComponent(query) + "?page=1&start=0&limit=5"
          const source = await fetch(url);
          const data = await source.json();
          const data2 = data.filter(row => row["ListValue"].endsWith(" - Address"))
          const data3 = data2.map(row => row["ListValue"].slice(0, -10))
          return data3;
        },
        cache: false
      },
      selector: "#addressInput",
      threshold: 2,
      debounce: 300,
      searchEngine: "loose",
      resultsList: {
        render: true,
        /* if set to false, add an eventListener to the selector for event type
           "autoComplete" to handle the result */
        container: source => {
          source.setAttribute("id", "address_results");
        },
        destination: document.querySelector("#addressInput"),
        position: "afterend",
        element: "ul"
      },
      maxResults: 5,
      highlight: true,
      resultItem: {
        content: (data, source) => {
          source.innerHTML = data.match;
        },
        element: "li"
      },
      onSelection: selected => {
        $('#addressInput').val(selected.selection.value);
      }
    });

  </script>
</body>

</html>