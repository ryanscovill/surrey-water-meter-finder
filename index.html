<!doctype html>

<html lang="en">

<head>
  <meta charset="utf-8">

  <title>City of Surrey - Water Meter Finder</title>
  <meta name="description" content="Find City of Surrey Water Meter">
  <meta name="author" content="Ryan Scovill">

  <link rel="stylesheet" href="css/styles.css">

</head>

<body>
  <div class="form">
    <h1>City of Surrey Water Meter Finder</h1>
    <form id="form">
      <div class="form-group">
        <label for="accoutnum">Account #: </label>
        <input type="text" id="accountnum" class="input input-md">
      </div>
      <label> <strong> <h3> OR </h3> </strong></label>
      <div class="form-group">
        <label for="addressInput">Address: </label>
        <input type="text" id="addressInput" class="input input-md">
      </div>
      <div class="form-group margin-top-1">
        <input type="submit" id="submit" value="Get Image" class="button"></input>
      </div>
    </form>
  </div>
  <div style="padding-top: 1em;">
    <div id="image-placeholder">
    </div>

  </div>
  <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.5.1/jquery.min.js"></script>
  <script>
    $(document).ready(function () {

      document.getElementById('form').onsubmit = function (e) {
        e.preventDefault();
        accountNum = document.getElementById('accountnum').value;
        address = $('#addressInput').val();
        $('#image-placeholder').html('')
        if (accountNum) {
          showImageAccountNum(accountNum);
        } else {
          showImage(address)
        }
      }
      function showImageAccountNum(accountNum) {
        imgHtml = '<img class="meter-image" src="https://cosmos.surrey.ca/geo_ref/Images/Water/WaterMeterPhotos/' + accountNum + '.jpg" >';
        html = "<div>"+imgHtml+"</div>"
        $('#image-placeholder').append(html)
      }
      function showImage(queryAddress) {
        // query for address
        url = "https://cosmos.surrey.ca/external/COSMOSWebServices/cosmos.svc/GetSearchData/"+encodeURIComponent(queryAddress)+"?page=1&start=0&limit=25"
          $.get(url, function (result){
            // todo show address results and user chooses
            addressId = result[0]["FieldValue"];
            // get Address info
            url = "https://gisservices.surrey.ca/arcgis/rest/services/Public/Legal/MapServer/find?f=json&searchText="+addressId+"&contains=false&returnGeometry=true&layers=0&searchFields=ADDRESSID"
            $.get(url, function(result) {
              houseNum = result.results[0].attributes["HOUSE NUMBER"]
              x = result.results[0].geometry.x;
              y = result.results[0].geometry.y;
              padding = 50
              boundingBox = {"xmin": x - 50, "ymin": y - 50, "xmax": x + 50, "ymax": y + 50}
              boundingBoxParam = encodeURIComponent(JSON.stringify(boundingBox))
              mapExtentParam = encodeURIComponent([boundingBox["xmin"],boundingBox["ymin"],boundingBox["xmax"],boundingBox["ymax"]].join(","))
              url = "https://gisservices.surrey.ca/arcgis/rest/services/Public/Water/MapServer/identify?f=json&tolerance=5&returnGeometry=true&returnFieldName=false&returnUnformattedValues=false&imageDisplay=1011%2C888%2C96&geometry="+boundingBoxParam+"&geometryType=esriGeometryEnvelope&mapExtent="+mapExtentParam+"&layers=visible%3A1%2C2"
              // get water services
              $.get(url, function(result) {
                //waterMeter = result.results[0].attributes
                $('#image-placeholder').html('')
                for (idx in result.results) {
                  meter = result.results[idx]
                  if(meter.hasOwnProperty('attributes') && meter.attributes.HOUSE == houseNum) {
                    if (meter.attributes.hasOwnProperty('IMAGE') && meter.attributes.IMAGE.length > 1) {
                      imgHtml = `<img class="meter-image" src="${meter.attributes.IMAGE}">`;
                    } else {
                      imgHtml = "<p> No image found </p>"
                    }
                    html = `
                    <div class="card">
                      ${imgHtml}
                      <p>Meter Account: ${meter.attributes["ACCOUNT NUMBER"]}</p>
                      <p>Installed Date: ${meter.attributes["INSTALLED DATE"]}</p>
                      <p>Last Read Date: ${meter.attributes["LAST READ DATE"]}</p>
                      <p>Location Description: ${meter.attributes["LOCATION DESCRIPTION"]}</p>
                    </div>
                      `
                    $('#image-placeholder').append(html)
                  }
                };
              })
            });
        })
      }
    })
  </script>
</body>

</html>